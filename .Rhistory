for(i in 1:nsim){
# Stage 1:
X0 = rbinom(N/4, 1, p0)
X1 = rbinom(N/4, 1, p1)
EE = sum(X1) # Events on Experimental arm at interim
EN = N/4 - EE  # Non-events on Experimental arm at interim
CE = sum(X0) # Events on Control arm at interim
CN = N/4 - CE # Non-events on Control arm at interim
RD_interim[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_interim[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
pval[i] = pnorm(RD_interim[i]/SE_interim[i])
# Stage 2:
Y0 = rbinom(N/4, 1, p0)
Y1 = rbinom(N/4, 1, p1)
EE = sum(X1+Y1) # Events on Experimental arm at end
EN = N/2 - EE # Non-events on Experimental arm at end
CE = sum(X0+Y0) # Events on Control arm at end
CN = N/2 - CE # Non-events on Control arm at end
RD_final[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_final[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
}
stop_early = (pval <= 0.001)
continue = (pval > 0.001)
trueRD <- p0-p1 # True RD no longer fixed at 0.05
# Table (slide 18)
one.trial <- rbind(
c(sum(stop_early), mean(RD_interim[stop_early]) + trueRD,
mean(SE_interim[stop_early])),
c(sum(continue), mean(RD_final[continue]) + trueRD,
mean(SE_final[continue])),
c(nsim, mean(c(RD_interim[stop_early], RD_final[continue])) + trueRD,
mean(c(SE_interim[stop_early],SE_final[continue]))),
c(nsim, weighted.mean(c(RD_interim[stop_early], RD_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)) + trueRD,
weighted.mean(c(SE_interim[stop_early], SE_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)))
)
colnames(one.trial) <- c("nsims", "Bias in RD", "Mean SE of RD")
rownames(one.trial) <- c("Stopped early", "Not stopped early", "All", "All, precision weighted")
signif(one.trial, 3)
}
twoArmTwoStage(p1=0.1, nsim=1e4)
twoArmTwoStage(p0=0.2, p1=0.1, nsim=1e4)
twoArmTwoStage(p0=0.2, p1=0.15, nsim=1e4)
theta.vec
theta.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(theta.vec))
for(i in 1:length(theta.vec)){
iw.all[[i]] <- twoArmTwoStage(p0=0.2, p1=0.15, nsim=1e4)
}
iw.all <- do.call(rbind, iw.all)
iw.all
twoArmTwoStage <- function(N=2428, nsim=1e4, p0=0.2, p1=0.15){
RD_interim = RD_final = SE_interim = SE_final = pval = rep(NA, N)
for(i in 1:nsim){
# Stage 1:
X0 = rbinom(N/4, 1, p0)
X1 = rbinom(N/4, 1, p1)
EE = sum(X1) # Events on Experimental arm at interim
EN = N/4 - EE  # Non-events on Experimental arm at interim
CE = sum(X0) # Events on Control arm at interim
CN = N/4 - CE # Non-events on Control arm at interim
RD_interim[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_interim[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
pval[i] = pnorm(RD_interim[i]/SE_interim[i])
# Stage 2:
Y0 = rbinom(N/4, 1, p0)
Y1 = rbinom(N/4, 1, p1)
EE = sum(X1+Y1) # Events on Experimental arm at end
EN = N/2 - EE # Non-events on Experimental arm at end
CE = sum(X0+Y0) # Events on Control arm at end
CN = N/2 - CE # Non-events on Control arm at end
RD_final[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_final[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
}
stop_early = (pval <= 0.001)
continue = (pval > 0.001)
trueRD <- p0-p1 # True RD no longer fixed at 0.05
# Table (slide 18)
one.trial <- rbind(
c(sum(stop_early), mean(RD_interim[stop_early]) + trueRD,
mean(SE_interim[stop_early])),
c(sum(continue), mean(RD_final[continue]) + trueRD,
mean(SE_final[continue])),
c(nsim, mean(c(RD_interim[stop_early], RD_final[continue])) + trueRD,
mean(c(SE_interim[stop_early],SE_final[continue]))),
c(nsim, weighted.mean(c(RD_interim[stop_early], RD_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)) + trueRD,
weighted.mean(c(SE_interim[stop_early], SE_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)))
)
one.trial <- cbind(one.trial,
rep(p0, 4),
rep(p1, 4))
colnames(one.trial) <- c("nsims", "Bias in RD", "Mean SE of RD", "p0", "p1")
rownames(one.trial) <- c("Stopped early", "Not stopped early", "All", "All, precision weighted")
#signif(one.trial, 3)
one.trial
}
theta.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(theta.vec))
for(i in 1:length(theta.vec)){
iw.all[[i]] <- twoArmTwoStage(p0=0.2, p1=0.15, nsim=1e4)
}
iw.all
p1.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(p1.vec))
for(i in 1:length(p1.vec)){
iw.all[[i]] <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
}
iw.all
twoArmTwoStage <- function(N=2428, nsim=1e4, p0=0.2, p1=0.15){
RD_interim = RD_final = SE_interim = SE_final = pval = rep(NA, N)
for(i in 1:nsim){
# Stage 1:
X0 = rbinom(N/4, 1, p0)
X1 = rbinom(N/4, 1, p1)
EE = sum(X1) # Events on Experimental arm at interim
EN = N/4 - EE  # Non-events on Experimental arm at interim
CE = sum(X0) # Events on Control arm at interim
CN = N/4 - CE # Non-events on Control arm at interim
RD_interim[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_interim[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
pval[i] = pnorm(RD_interim[i]/SE_interim[i])
# Stage 2:
Y0 = rbinom(N/4, 1, p0)
Y1 = rbinom(N/4, 1, p1)
EE = sum(X1+Y1) # Events on Experimental arm at end
EN = N/2 - EE # Non-events on Experimental arm at end
CE = sum(X0+Y0) # Events on Control arm at end
CN = N/2 - CE # Non-events on Control arm at end
RD_final[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_final[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
}
stop_early = (pval <= 0.001)
continue = (pval > 0.001)
trueRD <- p1-p0 # True RD no longer fixed at -0.05
# Table (slide 18)
one.trial <- rbind(
c(sum(stop_early), mean(RD_interim[stop_early]) - trueRD,
mean(SE_interim[stop_early])),
c(sum(continue), mean(RD_final[continue]) - trueRD,
mean(SE_final[continue])),
c(nsim, mean(c(RD_interim[stop_early], RD_final[continue])) - trueRD,
mean(c(SE_interim[stop_early],SE_final[continue]))),
c(nsim, weighted.mean(c(RD_interim[stop_early], RD_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)) - trueRD,
weighted.mean(c(SE_interim[stop_early], SE_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)))
)
one.trial <- cbind(one.trial,
rep(p0, 4),
rep(p1, 4))
colnames(one.trial) <- c("nsims", "Bias in RD", "Mean SE of RD", "p0", "p1")
rownames(one.trial) <- c("Stopped early", "Not stopped early", "All", "All, precision weighted")
#signif(one.trial, 3)
one.trial
}
p1.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(p1.vec))
for(i in 1:length(p1.vec)){
iw.all[[i]] <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
}
iw.all <- do.call(rbind, iw.all)
iw.all
twoArmTwoStage <- function(N=2428, nsim=1e4, p0=0.2, p1=0.15){
RD_interim = RD_final = SE_interim = SE_final = pval = rep(NA, N)
for(i in 1:nsim){
# Stage 1:
X0 = rbinom(N/4, 1, p0)
X1 = rbinom(N/4, 1, p1)
EE = sum(X1) # Events on Experimental arm at interim
EN = N/4 - EE  # Non-events on Experimental arm at interim
CE = sum(X0) # Events on Control arm at interim
CN = N/4 - CE # Non-events on Control arm at interim
RD_interim[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_interim[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
pval[i] = pnorm(RD_interim[i]/SE_interim[i])
# Stage 2:
Y0 = rbinom(N/4, 1, p0)
Y1 = rbinom(N/4, 1, p1)
EE = sum(X1+Y1) # Events on Experimental arm at end
EN = N/2 - EE # Non-events on Experimental arm at end
CE = sum(X0+Y0) # Events on Control arm at end
CN = N/2 - CE # Non-events on Control arm at end
RD_final[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_final[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
}
stop_early = (pval <= 0.001)
continue = (pval > 0.001)
trueRD <- p1-p0 # True RD no longer fixed at -0.05
# Table (slide 18)
one.sim <- rbind(
c(sum(stop_early), mean(RD_interim[stop_early]) - trueRD,
mean(SE_interim[stop_early])),
c(sum(continue), mean(RD_final[continue]) - trueRD,
mean(SE_final[continue])),
c(nsim, mean(c(RD_interim[stop_early], RD_final[continue])) - trueRD,
mean(c(SE_interim[stop_early],SE_final[continue]))),
c(nsim, weighted.mean(c(RD_interim[stop_early], RD_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)) - trueRD,
weighted.mean(c(SE_interim[stop_early], SE_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)))
)
one.sim <- cbind(one.sim,
rep(p0, 4),
rep(p1, 4))
colnames(one.sim) <- c("nsims", "Bias in RD", "Mean SE of RD", "p0", "p1")
rownames(one.sim) <- c("Stopped early", "Not stopped early", "All", "All, precision weighted")
#signif(one.sim, 3)
theta.hat <- c(RD_interim[stop_early], RD_final[continue])
all.theta.bar <- mean(theta.hat)
mc.error.bias <- sqrt( 1/(nsim*(nsim-1)) * sum((theta.hat-all.theta.bar)^2) )
return(list(one.sim=one.sim,
mc.error.bias=mc.error.bias))
}
p1.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(p1.vec))
for(i in 1:length(p1.vec)){
iw.all[[i]] <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
}
iw.all
iw.all[[1]]
p1.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(p1.vec))
twoArmTwoStage <- function(N=2428, nsim=1e4, p0=0.2, p1=0.15){
RD_interim = RD_final = SE_interim = SE_final = pval = rep(NA, N)
for(i in 1:nsim){
# Stage 1:
X0 = rbinom(N/4, 1, p0)
X1 = rbinom(N/4, 1, p1)
EE = sum(X1) # Events on Experimental arm at interim
EN = N/4 - EE  # Non-events on Experimental arm at interim
CE = sum(X0) # Events on Control arm at interim
CN = N/4 - CE # Non-events on Control arm at interim
RD_interim[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_interim[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
pval[i] = pnorm(RD_interim[i]/SE_interim[i])
# Stage 2:
Y0 = rbinom(N/4, 1, p0)
Y1 = rbinom(N/4, 1, p1)
EE = sum(X1+Y1) # Events on Experimental arm at end
EN = N/2 - EE # Non-events on Experimental arm at end
CE = sum(X0+Y0) # Events on Control arm at end
CN = N/2 - CE # Non-events on Control arm at end
RD_final[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_final[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
}
stop_early = (pval <= 0.001)
continue = (pval > 0.001)
trueRD <- p1-p0 # True RD no longer fixed at -0.05
# Table (slide 18)
one.sim <- rbind(
c(sum(stop_early), mean(RD_interim[stop_early]) - trueRD,
mean(SE_interim[stop_early])),
c(sum(continue), mean(RD_final[continue]) - trueRD,
mean(SE_final[continue])),
c(nsim, mean(c(RD_interim[stop_early], RD_final[continue])) - trueRD,
mean(c(SE_interim[stop_early],SE_final[continue]))),
c(nsim, weighted.mean(c(RD_interim[stop_early], RD_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)) - trueRD,
weighted.mean(c(SE_interim[stop_early], SE_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)))
)
one.sim <- cbind(one.sim,
rep(p0, 4),
rep(p1, 4))
colnames(one.sim) <- c("nsims", "Bias in RD", "Mean SE of RD", "p0", "p1")
rownames(one.sim) <- c("Stopped early", "Not stopped early", "All", "All, precision weighted")
#signif(one.sim, 3)
theta.hat <- c(RD_interim[stop_early], RD_final[continue])
all.theta.bar <- mean(theta.hat)
mc.error.bias <- sqrt( 1/(nsim*(nsim-1)) * sum((theta.hat-all.theta.bar)^2) )
return(list(one.sim=one.sim,
mc.error.bias=mc.error.bias))
}
p1.vec <- c(0.1, 0.5)
iw.all <- vector("list", length(p1.vec))
mc.error <- numeric(length(p1.vec))
for(i in 1:length(p1.vec)){
one.result <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
iw.results[[i]] <- one.result$one.sim
mc.error[i] <- one.result$mc.error.bias
}
iw.results <- vector("list", length(p1.vec))
mc.error <- numeric(length(p1.vec))
for(i in 1:length(p1.vec)){
one.result <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
iw.results[[i]] <- one.result$one.sim
mc.error[i] <- one.result$mc.error.bias
}
iw.results
mc.error
1e4
twoArmTwoStage <- function(N=2428, nsim=1e4, p0=0.2, p1=0.15){
RD_interim = RD_final = SE_interim = SE_final = pval = rep(NA, N)
for(i in 1:nsim){
# Stage 1:
X0 = rbinom(N/4, 1, p0)
X1 = rbinom(N/4, 1, p1)
EE = sum(X1) # Events on Experimental arm at interim
EN = N/4 - EE  # Non-events on Experimental arm at interim
CE = sum(X0) # Events on Control arm at interim
CN = N/4 - CE # Non-events on Control arm at interim
RD_interim[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_interim[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
pval[i] = pnorm(RD_interim[i]/SE_interim[i])
# Stage 2:
Y0 = rbinom(N/4, 1, p0)
Y1 = rbinom(N/4, 1, p1)
EE = sum(X1+Y1) # Events on Experimental arm at end
EN = N/2 - EE # Non-events on Experimental arm at end
CE = sum(X0+Y0) # Events on Control arm at end
CN = N/2 - CE # Non-events on Control arm at end
RD_final[i] = (EE/(EE+EN)) - (CE/(CE+CN))
SE_final[i] = sqrt(EE*EN/(EE+EN)^3 + CE*CN/(CE+CN)^3)
}
stop_early = (pval <= 0.001)
continue = (pval > 0.001)
trueRD <- p1-p0 # True RD no longer fixed at -0.05
# Table (slide 18)
one.sim <- rbind(
c(sum(stop_early), mean(RD_interim[stop_early]) - trueRD,
mean(SE_interim[stop_early])),
c(sum(continue), mean(RD_final[continue]) - trueRD,
mean(SE_final[continue])),
c(nsim, mean(c(RD_interim[stop_early], RD_final[continue])) - trueRD,
mean(c(SE_interim[stop_early],SE_final[continue]))),
c(nsim, weighted.mean(c(RD_interim[stop_early], RD_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)) - trueRD,
weighted.mean(c(SE_interim[stop_early], SE_final[continue]),
c(1/SE_interim[stop_early]^2, 1/SE_final[continue]^2)))
)
one.sim <- data.frame(one.sim,
rep(p0, 4),
rep(p1, 4),
c("Stopped early", "Not stopped early", "All (naive)", "All (precision-weighted)"))
names(one.sim) <- c("nsims", "Bias in RD", "Mean SE of RD", "p0", "p1", "type")
rownames(one.sim) <- c("Stopped early", "Not stopped early", "All (naive)", "All (precision-weighted)")
#signif(one.sim, 3)
theta.hat <- c(RD_interim[stop_early], RD_final[continue])
all.theta.bar <- mean(theta.hat)
mc.error.bias <- sqrt( 1/(nsim*(nsim-1)) * sum((theta.hat-all.theta.bar)^2) )
return(list(one.sim=one.sim,
mc.error.bias=mc.error.bias))
}
p1.vec <- c(0.1, 0.5)
iw.results <- vector("list", length(p1.vec))
mc.error <- numeric(length(p1.vec))
for(i in 1:length(p1.vec)){
one.result <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
iw.results[[i]] <- one.result$one.sim
mc.error[i] <- one.result$mc.error.bias
}
iw.results
iw.results <- do.call(rbind, iw.results)
iw.results.sub <- iw.results[all.simon2$type %in% c("All (naive)", "All (precision-weighted)"), ]
iw.results.sub <- iw.results[iw.results$type %in% c("All (naive)", "All (precision-weighted)"), ]
iw.plot <- ggplot(data=iw.results.sub, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p1-p0=-0.05)",
subtitle="Includes proportion of trials stopped early")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot
p1.vec <- seq(0.1, 0.8, 0.1)
iw.results <- vector("list", length(p1.vec))
mc.error <- numeric(length(p1.vec))
for(i in 1:length(p1.vec)){
one.result <- twoArmTwoStage(p0=p1.vec[i]+0.05, p1=p1.vec[i], nsim=1e4)
iw.results[[i]] <- one.result$one.sim
mc.error[i] <- one.result$mc.error.bias
}
iw.results <- do.call(rbind, iw.results)
iw.results.sub <- iw.results[iw.results$type %in% c("All (naive)", "All (precision-weighted)"), ]
iw.plot <- ggplot(data=iw.results.sub, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p1-p0=-0.05)",
subtitle="Includes proportion of trials stopped early")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot
iw.plot <- ggplot(data=iw.results.sub, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p1-p0=-0.05)",
subtitle="Includes proportion of trials stopped early")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
#geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
#geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot
iw.plot <- ggplot(data=iw.results.sub, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p1-p0=-0.05)")#,
#    subtitle="Includes proportion of trials stopped early")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
#geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
#geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
iw.plot <- ggplot(data=iw.results.sub, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p1-p0=-0.05)")+#,
#    subtitle="Includes proportion of trials stopped early")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
#geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
#geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot
iw.plot <- ggplot(data=iw.results.sub, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p1-p0=-0.05)",
subtitle="Varying p0 and p1, fixed p1-p0")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
#geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
#geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot
# Now fix p0 and vary p1 only:
p1.vec <- seq(0.1, 0.8, 0.1)
iw.results2 <- vector("list", length(p1.vec))
mc.error2 <- numeric(length(p1.vec))
for(i in 1:length(p1.vec)){
one.result <- twoArmTwoStage(p0=0.3, p1=p1.vec[i], nsim=1e4)
iw.results2[[i]] <- one.result$one.sim
mc.error2[i] <- one.result$mc.error.bias
}
iw.results2 <- do.call(rbind, iw.results2)
iw.results.sub2 <- iw.results2[iw.results2$type %in% c("All (naive)", "All (precision-weighted)"), ]
iw.plot2 <- ggplot(data=iw.results.sub2, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p0=0.30)",
subtitle="Varying p1 only, fixed p0")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
#geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
#geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub2$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot2
# Now fix p0 and vary p1 only:
p1.vec <- seq(0.1, 0.8, 0.05)
iw.results2 <- vector("list", length(p1.vec))
mc.error2 <- numeric(length(p1.vec))
for(i in 1:length(p1.vec)){
one.result <- twoArmTwoStage(p0=0.3, p1=p1.vec[i], nsim=1e4)
iw.results2[[i]] <- one.result$one.sim
mc.error2[i] <- one.result$mc.error.bias
}
iw.results2 <- do.call(rbind, iw.results2)
iw.results.sub2 <- iw.results2[iw.results2$type %in% c("All (naive)", "All (precision-weighted)"), ]
iw.plot2 <- ggplot(data=iw.results.sub2, mapping=aes(x=p1, y=`Bias in RD`, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True p1",
y="Bias (estimate - true RD)",
title="Bias in two-arm two-stage design (p0=0.30)",
subtitle="Varying p1 only, fixed p0")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
#geom_vline(aes(xintercept=p0[1]), col="grey", linetype="dashed")+
#geom_vline(aes(xintercept=p1[1]), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(iw.results.sub2$`Bias in RD`)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=p1.vec)#+
#scale_color_manual(values=simon.colours)
iw.plot2
#scale_color_manual(values=simon.colours)
iw.plot
#scale_color_manual(values=simon.colours)
iw.plot2
