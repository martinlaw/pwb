knitr::opts_chunk$set(echo = TRUE,
dev='png',
fig.path="figures/")
library(ggplot2)
# Simulate the trials:
nsims <- 10000
theta.MA <- seq(0.1, 0.9, 0.1)
pwbias <- rep(NA, length(theta.MA))
mean.se <- rep(NA, length(theta.MA))
for(i in 1:length(theta.MA)){
MA.results <- pwb::simMeta(N=100, theta=theta.MA[i], n.studies=5, nsims=nsims)
wtdmeans <- rep(NA, nsims)
ses <- rep(NA, nsims)
for(j in 1:nsims){
var.studies <- MA.results$se[j, ]^2
wi <- 1/var.studies
wtdmeans[j] <- weighted.mean(x=MA.results$theta.hat[j, ], w=wi)
var.ma <- 1/sum(wi)
ses[j] <- sqrt(var.ma)
}
pwbias[i] <- mean(wtdmeans-theta.MA[i])
mean.se[i] <- mean(ses)
}
bias.df <- data.frame(bias=pwbias,
se=mean.se,
lower=pwbias-1.95*mean.se,
upper=pwbias+1.95*mean.se,
theta=theta.MA)
ggplot(data=bias.df, mapping=aes(x=theta, y=bias))+
geom_line()+
geom_point()+
# geom_ribbon(aes(x=theta, ymin=lower, ymax=upper), fill="red", alpha=0.1)+
labs(x="True response probability theta",
y="Bias (precision weighted estimate - theta)",
title="Bias in meta-analysis studies",
subtitle="Five non-adaptive single-arm trials, N=100")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(c(bias.df$lower, bias.df$upper))) * c(-1, 1) )+
scale_x_continuous(breaks=theta.MA)
ggplot(data=bias.df, mapping=aes(x=theta, y=bias))+
geom_line()+
geom_point()+
# geom_ribbon(aes(x=theta, ymin=lower, ymax=upper), fill="red", alpha=0.1)+
labs(x="True response probability theta",
y="Bias (precision weighted estimate - theta)",
title="Bias in meta-analysis studies",
subtitle="Five non-adaptive single-arm trials, N=100")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
#  ylim(max(abs(c(bias.df$lower, bias.df$upper))) * c(-1, 1) )+
scale_x_continuous(breaks=theta.MA)
library(pwb)
ma.simon.results0
theta.vec.0.5 <- seq(0.1, 0.9, 0.1)
ma.simon.results0 <- vector("list", length(theta.vec.0.5))
for(i in 1:length(theta.vec.0.5)){
ma.simon.results0[[i]] <- maSimon(theta=theta.vec.0.5[i],
des=simon.des,
nsims=1e4,
n.studies=4)
}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
echo = TRUE,
dev='png',
fig.path="figures/")
library(pwb)
all.designs <- clinfun::ph2simon(pu=0.5,
pa=0.6,
ep1=0.05,
ep2=0.1,
nmax=500)
# Choose optimal Simon design:
opt.index <- which.min(all.designs$out[, "EN(p0)"])
simon.des <- all.designs$out[opt.index, ]
set.seed(1453)
ma.simon.results <- maSimon(theta=0.5,
des=simon.des,
nsims=1e4,
n.studies=4)
ma.simon.results
theta.vec.0.5 <- seq(0.1, 0.9, 0.1)
ma.simon.results0 <- vector("list", length(theta.vec.0.5))
for(i in 1:length(theta.vec.0.5)){
ma.simon.results0[[i]] <- maSimon(theta=theta.vec.0.5[i],
des=simon.des,
nsims=1e4,
n.studies=4)
}
ma.simon.results0 <- do.call(rbind, ma.simon.results0)
library(ggplot2)
ma.simon.plot0 <- ggplot(data=ma.simon.results0, mapping=aes(x=theta, y=bias, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True response probability theta",
y="Bias (estimate - theta)",
title="Bias in meta-analysis",
subtitle="One Simon design (p0=0.5, p1=0.6), four non-ADs")+
geom_vline(aes(xintercept=0.5), col="grey", linetype="dashed")+
geom_vline(aes(xintercept=0.6), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(ma.simon.results0$bias)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=theta.vec.0.5)+
theme(legend.position="bottom")
ma.simon.plot0
all.designs2 <- clinfun::ph2simon(pu=0.8,
pa=0.9,
ep1=0.05,
ep2=0.1,
nmax=150)
# Choose optimal Simon design:
opt.index <- which.min(all.designs2$out[, "EN(p0)"])
simon.des2 <- all.designs2$out[opt.index, ]
theta.vec <- seq(0.5, 0.9, 0.05)
ma.simon.results2 <- vector("list", length(theta.vec))
for(i in 1:length(theta.vec)){
ma.simon.results2[[i]] <- maSimon(theta=theta.vec[i],
des=simon.des2,
nsims=1e4,
n.studies=4)
}
ma.simon.results2 <- do.call(rbind, ma.simon.results2)
ma.simon.plot <- ggplot(data=ma.simon.results2, mapping=aes(x=theta, y=bias, col=type))+
geom_line(alpha=0.4, size=1)+
geom_point()+
labs(x="True response probability theta",
y="Bias (estimate - theta)",
title="Bias in meta-analysis",
subtitle="One Simon design (p0=0.8, p1=0.9), four non-ADs")+
#annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
geom_vline(aes(xintercept=0.8), col="grey", linetype="dashed")+
geom_vline(aes(xintercept=0.9), col="grey", linetype="dashed")+
geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
ylim(max(abs(ma.simon.results2$bias)) * c(-1.1, 1.1) )+
scale_x_continuous(breaks=theta.vec)+
theme(legend.position="bottom")
ma.simon.plot
all.designs3 <- clinfun::ph2simon(pu=0.2,
pa=0.3,
ep1=0.05,
ep2=0.1,
nmax=200)
# Choose optimal Simon design:
opt.index <- which.min(all.designs3$out[, "EN(p0)"])
simon.des3 <- all.designs3$out[opt.index, ]
theta.vec.low <- seq(0.1, 0.4, 0.05)
ma.simon.results3 <- vector("list", length(theta.vec.low))
for(i in 1:length(theta.vec.low)){
ma.simon.results3[[i]] <- maSimon(theta=theta.vec.low[i],
des=simon.des3,
nsims=1e4,
n.studies=4)
}
ma.simon.results3 <- do.call(rbind, ma.simon.results3)
# Biggest improvement in bias:
max(abs(ma.simon.results3$bias[ma.simon.results3$type=="All trials"])-abs(ma.simon.results3$bias[ma.simon.results3$type=="Exclude early stopped"]))
ma.simon.plot0
ma.simon.results0
expression(p[0]=0.5*", "*p[1]=0.6)
expression("p"*[0]==0.5*", "*"p"[1]==0.6)
bquote("p"*[0]==0.5*", "*"p"[1]==0.6)
?bquote
ma.simon.results0$p0p1 <- bquote("p"~[0]==0.5~", p"~[1]==0.6)
ma.simon.results0$p0p1 <- bquote(p[0]==0.5~", p"~[1]==0.6)
ma.simon.results0$p0p1 <- bquote(p[0]==0.5~","~p[1]==0.6)
bquote(p[0]==0.5~","~p[1]==0.6)
ma.simon.results0$p0p1 <- bquote(p[0]==0.5~","~p[1]==0.6)
#ma.simon.results0$p0p1 <- bquote(p[0]==0.5~","~p[1]==0.6)
ma.simon.results0$p0p1 <- "p0=0.5, p1=0.6"
