---
title: "Meta-analysis: Simon design"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MA_simon}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(pwb)
```

Find a Simon design with p0=0.5, p1=0.6, type-I error-rate 0.05, power
0.9:

```{r, simon}
all.designs <- clinfun::ph2simon(pu=0.5,
                                 pa=0.6,
                                 ep1=0.05,
                                 ep2=0.1,
                                 nmax=500)
# Choose optimal Simon design:
opt.index <- which.min(all.designs$out[, "EN(p0)"])
simon.des <- all.designs$out[opt.index, ]
```

Now simulate meta-analyses of a single Simon design and some number of single-arm single-stage trials with the same maximum sample size _N_ as the Simon design. We also choose the true response probability theta.

```{r}
ma.simon.results <- maSimon(theta=0.5,
                            des=simon.des,
                            nsims=1e4,
                            n.studies=4)
ma.simon.results
```

#### Moving away from theta=0.5

As with the single Simon design, let us examine what happens when the response rate is not close to 0.5. Here, we obtain a Simon design for p0=0.8, p1=0.9:

```{r, simon high p}
all.designs2 <- clinfun::ph2simon(pu=0.8,
                                 pa=0.9,
                                 ep1=0.05,
                                 ep2=0.1,
                                 nmax=150)
# Choose optimal Simon design:
opt.index <- which.min(all.designs2$out[, "EN(p0)"])
simon.des2 <- all.designs2$out[opt.index, ]
```

Again, simulate meta-analyses of this Simon design and single-arm single-stage trials with the same maximum sample size _N_ as the Simon design:

```{r, large thetea}
theta.vec <- seq(0.5, 0.9, 0.05)
ma.simon.results2 <- vector("list", length(theta.vec))
for(i in 1:length(theta.vec)){
  ma.simon.results2[[i]] <- maSimon(theta=theta.vec[i],
                                    des=simon.des2,
                                    nsims=1e4,
                                    n.studies=4)
  }

ma.simon.results2 <- do.call(rbind, ma.simon.results2)


```
```{r simon plot 2 subset, fig.height=4, fig.width=6, echo=FALSE, warning=T}
#### Plot bias -- no subsetting of "stopped early" or "stopped at N" ####
library(ggplot2)
ma.simon.plot <- ggplot(data=ma.simon.results2, mapping=aes(x=theta, y=bias, col=type))+
  geom_line(alpha=0.4, size=1)+
  geom_point()+
  labs(x="True response probability theta",
       y="Bias (estimate - theta)",
       title="Bias in meta-analysis",
       subtitle="One Simon design (p0=0.8, p1=0.9), four non-ADs")+
  #annotate("text", x=theta.vec2, y=-0.015, label=round(stop.early.count2,2))+
  geom_vline(aes(xintercept=0.8), col="grey", linetype="dashed")+
  geom_vline(aes(xintercept=0.9), col="grey", linetype="dashed")+
  geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
  ylim(max(abs(ma.simon.results2$bias)) * c(-1.1, 1.1) )+
  scale_x_continuous(breaks=theta.vec)
ma.simon.plot
```
