---
title: 'Meta-analysis: general'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
```

## Meta-analysis with no adaptive designs

Consider a meta-analysis comprised of _n.studies_ binary outcome trials, all with
sample size _N_. Examine a range of true response probabilities *theta*:

```{r meta}
# Simulate the trials:
nsims <- 100000
theta.MA <- seq(0.1, 0.9, 0.1)
bias <- rep(NA, length(theta.MA))
mean.se <- rep(NA, length(theta.MA))

for(i in 1:length(theta.MA)){
  MA.results <- pwb::simMeta(N=100, theta=theta.MA[i], n.studies=5, nsims=nsims)
  wtdmeans <- rep(NA, nsims)
  ses <- rep(NA, nsims)
  for(j in 1:nsims){
    var.studies <- MA.results$se[j, ]^2
    wi <- 1/var.studies
    wtdmeans[j] <- weighted.mean(x=MA.results$theta.hat[j, ], w=wi)
    var.ma <- 1/sum(wi)
    ses[j] <- sqrt(var.ma)
  }
  bias[i] <- mean(wtdmeans-theta.MA[i])
  mean.se[i] <- mean(ses)
}
bias.df <- data.frame(bias=bias,
                      se=mean.se,
                      lower=bias-1.95*mean.se,
                      upper=bias+1.95*mean.se,
                      theta=theta.MA)
```

```{r plot bias}
ggplot(data=bias.df, mapping=aes(x=theta, y=bias))+
 geom_line()+
 geom_point()+
  geom_ribbon(aes(x=theta, ymin=lower, ymax=upper), fill="red", alpha=0.1)+
  labs(x="True response probability theta",
       y="Bias (estimate - theta)",
      title="Bias in meta-analysis",
       subtitle="No adaptive designs")+
  geom_hline(aes(yintercept=0), col="grey", linetype="dashed")+
  ylim(max(abs(c(bias.df$lower, bias.df$upper))) * c(-1, 1) )+
  scale_x_continuous(breaks=theta.MA)
```

